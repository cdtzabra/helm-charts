# Cloudnative-pg Instance - CNPG Cluster

The purpose of this chart is to spawn a cnpg cluster instances...

It offers options for creating the different types of cloudnative-pg clusters: see [cnpg-cluster](https://cloudnative-pg.io/documentation/current/samples/) examples.



## Create a cloudnative-pg cluster - cnpg cluster

**Cloudnative-pg operator (cnpg-operator) must be installed first on your cluster** before installing this chart.


Example of `custom-values.yaml`

```yaml
---
# create pg cluster for keycloak
fullnameOverride: keycloak-cnpg-cluster

bootstrap:
  initdb:
    database: bitnami_keycloak  # inital database to create
    owner: bn_keycloak          # inital database user

storage:
  resizeInUseVolumes: true
  size: 10Gi           # postgres pvc size


# backup to s3
backup_enabled: true
backup:
  s3_endpointURL: "https://s3.example.com"  
  s3_destinationPath: "s3://cnpg-cluster/db-keycloak"   # bucket/folder-for-keycloak
  s3_credential:
    secretName: "cnpg-cluster-s3-backup"                        # You must create this secret first  with the keys below
    secret_accesKey: "ACCESS_KEY_ID"
    secret_secretKey: "ACCESS_SECRET_KEY"
    # kubectl create secret generic cnpg-cluster-s3-backup cnpg-cluster-s3-backup --from-literal ACCESS_KEY_ID="xx" --from-literal ACCESS_SECRET_KEY="yy"


# Scheduled Backup
# See the chart values.yaml file for more details about this section
scheduledbackup:
  enabled: true
  # perform an immediate backup as soon as the resource is created
  immediate: false
  schedule: "0 0 */8 * * *"
  # Beware that this format accepts also the seconds field, and it is different from the crontab format in Unix/Linux systems.
  # it has a total of 6 fiels while kubernetes/linux cronjob has 5

```

Deploy the chart: `helm install keycloak-cnpg-cluster ./ -n keycloak --create-namespace -f custom-values.yaml --atomic`


## Replica cluster

Example of a replica cluster values file using the `pg_basebackup` option.

```yaml
---
fullnameOverride: replica-cnpg-cluster

replica:
  enabled: true
  source: "main-pg-cluster"

bootstrap_use_initdb: false
bootstrap_use_pg_basebackup: true
bootstrap:
  pg_basebackup:
    source_cluster: "main-pg-cluster"
    source_database: "bitnami_keycloak"

externalClusters:
- name: main-pg-cluster
  connectionParameters:
    host: 10.xy.yz.zz   # LB/Node IP that expose the Primary cluster
    port: "5432"
    user: streaming_replica
    sslmode: prefer     #  options https://jdbc.postgresql.org/documentation/ssl/
    dbname: postgres
  sslKey:
    name: main-pg-cluster-replication
    key: tls.key
  sslCert:
    name: main-pg-cluster-replication
    key: tls.crt
  sslRootCert:
    name: main-pg-cluster-ca
    key: ca.crt

# backup to s3
# you can enable S3 backup for this replica cluster also
```

>[!warning]
> When the Replica cluster (Designated Primary) is not on the same Kubernetes/Openshit cluster as the Primary cluster, there are prerequisites to be met:
>
> * Expose the primary cluster by creating a **Loadbalancer** or **NodePort** service so that the replica can reach it.
> * Ensure that the Primary cluster's replication user(replication) secret is available on the Kubernetes/Openshift cluster targeted by the replica cluster. 

> Expose the primary cluster by creating a **Loadbalancer** service

```yaml
apiVersion: v1
kind: Service
metadata:
  annotations:
    loadbalancer.openstack.org/floating-network-id: "sss25ab9-kkk6-4foo-nn-5472eeee"
    loadbalancer.openstack.org/enable-health-monitor: "true"
  labels:
    cnpg.io/cluster: keycloak-cnpg-cluster 
  name:keycloak-cnpg-cluster-rw-loadbalancer
  namespace: <my-namespace>
spec:
  ports:
  - name: "5432"
    port: 5432
    protocol: TCP
    targetPort: 5432
  selector:
    cnpg.io/cluster: keycloak-cnpg-cluster
  type: LoadBalancer
```

> **Certificates Secret for connection** : `<clustername-replication>`

If you didn't create and fill in the helm value `certificates.replicationTLSSecret` when creating your Primary cluster,
then it was generated by the CNPG controller with the name `<clustername-replication>`: ( keycloak-cnpg-cluster-replication).

You must then copy, synchronize this secret to the cluster that will host the Replica cluster with the name you entered in **externalClusters** (`main-pg-cluster-replication` in the example above).

Note that the Replica cluster will also have its replication user with its secret <replica-cnpg-cluster-replication>, so don't confuse them.

And **if you've created your own secret** `certificates.replicationTLSSecret` simply deploy it on the second cluster as well, making sure that the secret number and the one entered in externalClusters are the same.
